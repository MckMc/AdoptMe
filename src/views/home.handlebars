<h1>Productos</h1>

{{!-- form --}}
<details style="margin:12px 0">
  <summary><b>Crear producto</b></summary>
  <form id="createProduct" style="margin-top:8px">
    <input name="title" placeholder="title" required />
    <input name="description" placeholder="description" required />
    <input name="code" placeholder="code" required />
    <input name="price" type="number" step="0.01" placeholder="price" required />
    <input name="stock" type="number" placeholder="stock" required />
    <input name="category" placeholder="category" required />
    <button type="submit">Crear</button>
  </form>
</details>

<ul>
  {{#each payload}}
    <li>
      <b>{{this.title}}</b> — ${{this.price}} — stock: {{this.stock}}
      <button onclick="addToCart('{{this._id}}')">Agregar al carrito</button>
    </li>
  {{/each}}
</ul>

<p><a id="verCarrito" href="#">Ver carrito</a></p>

<nav>
  {{#if hasPrevPage}} <a href="{{prevLink}}">« Anterior</a> {{/if}}
  <span>Página {{page}} / {{totalPages}}</span>
  {{#if hasNextPage}} <a href="{{nextLink}}">Siguiente »</a> {{/if}}
</nav>

<script>
(async () => {
  let cartId = localStorage.getItem('cartId');
  if (!cartId) {
    const res = await fetch('/api/carts', { method: 'POST' });
    if (!res.ok) return alert('No se pudo crear el carrito');
    const data = await res.json();
    cartId = data._id || data.id;
    localStorage.setItem('cartId', cartId);
  }
  document.getElementById('verCarrito').href = `/carts/${cartId}`;

  //Agregar al carrito
  window.addToCart = async (pid) => {
    const res = await fetch(`/api/carts/${cartId}/product/${pid}`, { method: 'POST' });
    if (!res.ok) return alert('No se pudo agregar al carrito');
    alert('Agregado al carrito ✔');
  };

  //Crear producto por HTTP
  document.getElementById('createProduct').addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(e.target));
    // tipos correctos
    data.price = Number(data.price);
    data.stock = Number(data.stock);
    data.status = true;
    data.thumbnails = [];

    const res = await fetch('/api/products', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify(data)
    });

    if (!res.ok) {
      const txt = await res.text();
      alert('No se pudo crear el producto');
      console.error(txt);
      return;
    }
    e.target.reset();
    location.reload();
  });
})();
</script>
